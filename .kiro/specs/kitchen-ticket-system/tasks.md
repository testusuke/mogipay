# 実装計画 - 料理人向け半券機能

## 1. データベース基盤の構築

- [ ] 1.1 キッチンチケット用のデータベーステーブルを作成する

  - Alembic マイグレーションファイルを作成し、kitchen_tickets テーブルを定義
  - 主キー、外部キー、UNIQUE 制約を設定
  - 未完了チケット検索用の部分インデックスを作成
  - マイグレーションの適用とロールバックをテストして正常性を確認
  - _要件: 3.4 (完了記録)_

- [ ] 1.2 データベーステーブルの制約とインデックスを検証する
  - 外部キー制約が正しく機能することを確認
  - UNIQUE 制約が重複チケット作成を防ぐことを確認
  - 部分インデックスがクエリパフォーマンスを向上させることを確認
  - _要件: 全要件の基盤_

## 2. バックエンド: データアクセス層の実装

- [ ] 2.1 キッチンチケット用の ORM モデルを実装する

  - SQLAlchemy モデルとして KitchenTicket クラスを定義
  - カラムマッピングとリレーションシップを設定
  - 型安全性を保証する Pydantic スキーマを作成
  - _要件: 3.4 (完了記録のデータ構造)_

- [ ] 2.2 キッチンチケットリポジトリを実装する
  - 未完了チケットの販売 ID リストを取得する機能
  - 新しいチケットを作成する機能
  - チケットを完了済みとしてマークする機能
  - 販売 ID からチケットを取得する機能
  - ユニットテストで各メソッドの動作を検証
  - _要件: 3.2, 3.4 (チケット削除と完了記録)_

## 3. バックエンド: ビジネスロジック層の実装

- [ ] 3.1 アクティブなチケット一覧を取得する機能を実装する

  - 未完了のチケットを販売履歴から取得
  - 注文時刻の古い順にソート
  - 注文からの経過時間を計算
  - セット商品を構成要素に展開
  - ユニットテストで正しいデータ変換を検証
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.3, 5.1, 5.2, 5.3 (チケット自動表示、時系列順、セット商品展開)_

- [ ] 3.2 チケット完了処理の機能を実装する

  - チケット ID から対象チケットを検索
  - 存在チェックと完了済みチェックを実行
  - 完了時刻と処理者情報を記録
  - エラーハンドリング(NOT_FOUND, ALREADY_COMPLETED)を実装
  - ユニットテストで正常系と異常系を検証
  - _要件: 3.2, 3.4 (チケット削除と完了記録)_

- [ ] 3.3 セット商品の展開ロジックを実装する
  - セット商品 ID から構成単品のリストを取得
  - 数量を掛け算して正確な個数を計算
  - 階層的なデータ構造(セット名 + 単品リスト)を構築
  - ユニットテストでセット展開の正確性を検証
  - _要件: 1.2, 5.2, 5.3 (セット商品の自動表示と構成要素表示)_

## 4. バックエンド: API エンドポイントの実装

- [ ] 4.1 チケット一覧取得 API を実装する

  - GET /api/kitchen/tickets エンドポイントを作成
  - KitchenTicketService からアクティブなチケットを取得
  - Pydantic スキーマで JSON レスポンスを構築
  - 認証ミドルウェアを適用して認証済みユーザーのみアクセス可能に
  - API 統合テストで正常なレスポンスを検証
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.3, 6.1 (チケット表示とリアルタイム更新)_

- [ ] 4.2 チケット完了 API を実装する

  - POST /api/kitchen/tickets/:ticket_id/complete エンドポイントを作成
  - リクエストボディから completed_by を取得
  - KitchenTicketService で完了処理を実行
  - エラーレスポンス(404, 409, 500)を適切に返却
  - API 統合テストで正常系と異常系を検証
  - _要件: 3.1, 3.2, 3.4 (調理完了ボタン、チケット削除、完了記録)_

- [ ] 4.3 エラーハンドリングとバリデーションを実装する
  - Pydantic バリデーションで入力チェック
  - カスタム例外クラスを定義(TicketNotFoundError, AlreadyCompletedError)
  - FastAPI の例外ハンドラーで適切な HTTP ステータスコードを返却
  - API 統合テストで各エラーケースを検証
  - _要件: 全要件のエラー対応_

## 5. バックエンド: テストの実装

- [ ] 5.1 リポジトリ層のユニットテストを実装する

  - 未完了チケット取得のテスト
  - チケット作成のテスト
  - チケット完了のテスト
  - データベース制約違反のテスト
  - _要件: 2.1, 3.2, 3.4 (時系列順、チケット削除、完了記録)_

- [ ] 5.2 サービス層のユニットテストを実装する

  - アクティブなチケット一覧取得のテスト(ソート順、経過時間)
  - セット商品展開のテスト
  - チケット完了処理のテスト(正常系と異常系)
  - _要件: 1.2, 2.1, 2.3, 3.2, 5.2, 5.3 (セット商品、時系列順、経過時間、完了処理)_

- [ ] 5.3 API 層の統合テストを実装する
  - チケット一覧取得 API のテスト
  - チケット完了 API のテスト(正常系と 404, 409 エラー)
  - 認証チェックのテスト
  - _要件: 6.1, 7.1 (リアルタイム更新、操作性)_

## 6. フロントエンド: UI コンポーネントの実装

- [ ] 6.1 キッチンチケット一覧画面のレイアウトを実装する

  - Next.js ページコンポーネントを作成(/kitchen ルート)
  - shadcn/ui の Card コンポーネントでチケットを表示
  - レスポンシブデザインでモバイル対応
  - タッチ操作に最適化された大きめのボタンサイズ
  - _要件: 1.4, 7.1, 7.2, 7.4 (視認性、タッチ操作、モバイル UI)_

- [ ] 6.2 単品商品のチケット表示コンポーネントを実装する

  - 商品名を大きく表示
  - 数量を商品名の近くに配置
  - 複数個の場合は数量を強調表示
  - 商品カテゴリや優先度を色で視覚的に区別
  - _要件: 4.1, 4.2, 4.3, 4.4 (単品商品の表示仕様)_

- [ ] 6.3 セット商品のチケット表示コンポーネントを実装する

  - セット名を見出しとして表示
  - 構成単品をリスト形式で表示
  - 各単品の数量を表示
  - 単品とセットを視覚的に区別(インデント、背景色など)
  - _要件: 5.1, 5.2, 5.3, 5.4 (セット商品の表示仕様)_

- [ ] 6.4 経過時間表示機能を実装する

  - 注文からの経過時間を「◯ 分前」形式で表示
  - クライアント側で自動更新(1 分ごと)
  - 長時間経過したチケットは色を変えて警告
  - _要件: 2.3, 2.4 (経過時間表示と自動更新)_

- [ ] 6.5 調理完了ボタンを実装する
  - 各チケットに大きなタッチ可能なボタンを配置
  - ボタン押下時に確認ダイアログを表示
  - 完了後にチケットをリストから削除
  - ローディング状態の表示
  - _要件: 3.1, 3.2, 3.3, 7.1 (調理完了ボタン、チケット削除、操作性)_

## 7. フロントエンド: データフェッチとポーリングの実装

- [ ] 7.1 チケット一覧取得の API クライアントを実装する

  - fetch または axios でバックエンド API を呼び出し
  - TypeScript の型定義を作成
  - エラーハンドリング(ネットワークエラー、タイムアウト)
  - _要件: 6.1 (リアルタイム更新)_

- [ ] 7.2 3 秒間隔のポーリングメカニズムを実装する

  - useEffect フックで 3 秒ごとにチケット一覧を取得
  - 差分検出ロジックで新規チケットと削除されたチケットを判別
  - コンポーネントのアンマウント時にタイマーをクリア
  - _要件: 2.2, 6.1, 6.2 (新規注文の自動挿入、リアルタイム更新)_

- [ ] 7.3 チケット完了 API の呼び出しを実装する
  - POST リクエストでチケット完了を送信
  - レスポンスに応じて UI を更新
  - エラーレスポンス(404, 409)の適切なハンドリング
  - _要件: 3.1, 3.2 (調理完了ボタン、チケット削除)_

## 8. フロントエンド: エラーハンドリングと UX の実装

- [ ] 8.1 ネットワークエラーハンドリングを実装する

  - 接続エラー時に警告メッセージを表示
  - 自動リトライロジック(5 秒後に再試行、最大 3 回)
  - 接続復旧時にチケット一覧を再取得
  - _要件: 6.3, 6.4 (接続切断の警告、接続復旧時の再取得)_

- [ ] 8.2 API エラーハンドリングを実装する

  - 404 エラー: 「チケットが見つかりません」メッセージを表示し、リストを再取得
  - 409 エラー: 「既に完了済みです」メッセージを表示し、該当チケットを削除
  - 500 エラー: 「システムエラーが発生しました」メッセージを表示
  - _要件: 全要件のエラー対応_

- [ ] 8.3 ローディング状態と空状態の UI を実装する
  - 初回ロード中のスケルトン UI
  - チケットが 0 件の場合の空状態メッセージ
  - ボタン押下時のローディングインジケーター
  - _要件: 7.3 (最小限のスクロール操作)_
